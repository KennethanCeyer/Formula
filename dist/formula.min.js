//================================================================================
// [jquery-formula]
// version: 1.0.0
// update: 2016.03.18
//================================================================================

function formulaComposer(a){return this.formula=a,this.primaryPriority=["*","x","/","%"],this.secondaryPriority=["+","-","&"],this.permittedOperators=["+","-","*","x","/"],this.permittedLetters=["(",")"].concat(this.permittedOperators),this.init()}!function(a){String.prototype.toDecimal=function(){var a=this.split(".");return a[0].replace(/[^\d.]+/gi,"").replace(/\B(?=(\d{3})+(?!\d))/g,",")+("undefined"!=typeof a[1]?"."+a[1]:"")},String.prototype.toFormulaString=function(a){var b=this;return 106==b?"x":(187===b||61===b)&&a===!0||107===b?"+":189===b||173===b||109===b?"-":190===b||110===b?".":191===b||111===b?"/":String.fromCharCode(b)},a.fn.formula=function(b){var c={id:"formula",cursorAnimTime:160,cursorDelayTime:500,extract:{filter:function(a){return a},item:function(a){return a.text()}}},d=arguments;return a.extend(c,b),this.each(function(){this.init=function(){var b=this,c=!1,d=!1;this.container=a(this).addClass(this.opt.id+"-container"),this.container.wrap('<div class="'+this.opt.id+'-wrapper"></div>'),this.alert=a('<div class="'+this.opt.id+'-alert">Formula</div>'),this.alert.insertBefore(b.container),this.text=a('<textarea id="'+this.opt.id+'-text" name="'+this.opt.id+'-text" class="'+this.opt.id+'-text"></textarea>'),this.text.insertAfter(this.container).focus(),this.text.unbind("dblclick."+this.opt.id+"Handler").bind("dblclick."+this.opt.id+"Handler",function(a){b.selectAll()}),this.text.unbind("mousedown."+this.opt.id+"Handler").bind("mousedown."+this.opt.id+"Handler",function(a){c=!0}),this.text.unbind("mouseup."+this.opt.id+"Handler").bind("mouseup."+this.opt.id+"Handler",function(a){c=!1,d===!0?d=!1:b.click({x:a.offsetX,y:a.offsetY})});var e;this.text.unbind("mousemove."+this.opt.id+"Handler").bind("mousemove."+this.opt.id+"Handler",function(f){if(b.container.hasClass("formula-active")&&b.click({x:f.offsetX,y:f.offsetY}),c!==!0)return!0;if(d=!0,b.container.find("."+b.opt.id+"-drag").length>0){var g=0;b.destroyDrag(),b.click({x:f.offsetX,y:f.offsetY}),g=b.cursor.index(),$drag=a('<div class="'+b.opt.id+'-drag"></div>');var h=0,i=0;if(e>g?(i=e,h=g,$drag.insertBefore(b.cursor)):(h=e,i=g,$drag.insertAfter(b.cursor)),h==i)return!0;b.container.children(':not(".'+b.opt.id+'-cursor")').filter(':gt("'+h+'")').filter(':lt("'+(i-h)+'")').add(b.container.children(':not(".'+b.opt.id+'-cursor")').eq(h)).each(function(){var b=a(this);b.appendTo($drag)}),e>g?$drag.insertAfter(b.cursor):$drag.insertBefore(b.cursor)}else b.destroyDrag(),b.click({x:f.offsetX,y:f.offsetY}),e=b.cursor.index(),$drag=a('<div class="'+b.opt.id+'-drag"></div>'),$drag.insertAfter(b.cursor)}),b.text.unbind("keydown."+this.opt.id+"Handler").bind("keydown."+this.opt.id+"Handler",function(c){c.preventDefault();var d,e,f,g,h,i,j;if(b.cursor.length>0){var k=c.which;if(116==k||82==k&&c.ctrlKey)location.reload();else if(65==k&&c.ctrlKey)b.selectAll();else if(k>=96&&105>=k)k-=48;else{if(8==k)return d=b.container.find("."+b.opt.id+"-drag"),d.length>0?(b.cursor.insertBefore(d),d.remove()):b.cursor.length>0&&b.cursor.prev().length>0&&(e=b.cursor.prev(),e.hasClass(b.opt.id+"-unit")&&e.text().length>1?(i=e.text(),b.setDecimal(e,i.substring(0,i.length-1).toDecimal())):e.remove()),b.syntaxCheck(),!1;if(46==k)return d=b.container.find("."+b.opt.id+"-drag"),d.length>0?(b.cursor.insertAfter(d),d.remove()):b.cursor.length>0&&b.cursor.next().length>0&&(f=b.cursor.next(),f.hasClass(b.opt.id+"-unit")&&f.text().length>1?(i=f.text(),b.setDecimal(f,i.substring(1,i.length).toDecimal())):f.remove()),b.syntaxCheck(),!1;if(k>=37&&40>=k)return 37==k?b.cursor.length>0&&b.cursor.prev().length>0?c.shiftKey?(d=b.container.find("."+b.opt.id+"-drag"),d.length<1?(d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertAfter(b.cursor)):d.data("active")===!1&&(b.destroyDrag(),d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertAfter(b.cursor)),d.data("active",!0),e=b.cursor.prev(),e.hasClass(b.opt.id+"-drag")?(h=d.children("*"),h.length<1?d.remove():(h.last().insertAfter(d),b.cursor.insertAfter(d))):b.cursor.prev().prependTo(d)):(b.destroyDrag(),b.cursor.insertBefore(b.cursor.prev())):b.destroyDrag():38==k?(b.cursor.prev().length>0||b.cursor.next().length>0)&&(j={x:parseFloat(b.container.css("padding-left").replace(/[^\d.]/gi,"")),y:parseFloat(b.container.css("padding-top").replace(/[^\d.]/gi,""))},g=b.cursor.prev(),g.length<0&&(g=b.cursor.next()),b.click({x:b.cursor.position().left+g.outerWidth(),y:b.cursor.position().top-g.outerHeight()/2})):39===k?b.cursor.length>0&&b.cursor.next().length>0?c.shiftKey?(d=b.container.find("."+b.opt.id+"-drag"),d.length<1?(d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertBefore(b.cursor)):d.data("active")===!1&&(b.destroyDrag(),d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertBefore(b.cursor)),d.data("active",!0),f=b.cursor.next(),f.hasClass(b.opt.id+"-drag")?(h=d.children("*"),h.length<1?d.remove():(h.first().insertBefore(d),b.cursor.insertBefore(d))):b.cursor.next().appendTo(d)):(b.destroyDrag(),b.cursor.insertAfter(b.cursor.next())):b.destroyDrag():40==k&&(b.cursor.prev().length>0||b.cursor.next().length>0)&&(j={x:parseFloat(b.container.css("padding-left").replace(/[^\d.]/gi,"")),y:parseFloat(b.container.css("padding-top").replace(/[^\d.]/gi,""))},g=b.cursor.prev(),g.length<0&&(g=b.cursor.next()),b.click({x:b.cursor.position().left+g.outerWidth(),y:b.cursor.position().top+1.5*g.outerHeight()})),!1;(35==k||36==k)&&(35==k?b.cursor.length>0&&b.container.children(":last").length>0&&(c.shiftKey?(d=b.container.find("."+b.opt.id+"-drag"),d.length<1?(d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertBefore(b.cursor)):d.data("active")===!1&&(b.destroyDrag(),d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertBefore(b.cursor)),d.data("active",!0),b.cursor.nextAll().appendTo(d)):(b.destroyDrag(),b.cursor.insertAfter(b.container.children(":last")))):36==k&&b.cursor.length>0&&b.container.children(":first").length>0&&(c.shiftKey?(d=b.container.find("."+b.opt.id+"-drag"),d.length<1?(d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertAfter(b.cursor)):d.data("active")===!1&&(b.destroyDrag(),d=a('<div class="'+b.opt.id+'-drag"></div>'),d.insertAfter(b.cursor)),d.data("active",!0),b.cursor.prevAll().each(function(){var b=a(this);b.prependTo(d)})):(b.destroyDrag(),b.cursor.insertBefore(b.container.children(":first")))))}b.keydown(k.toString().toFormulaString(c.shiftKey),c.shiftKey),b.syntaxCheck()}}),this.click({x:0,y:0})},this.syntaxCheck=function(a){var b=this,c=b.getFormula();if("undefined"!=typeof c){console.log(c);var d=new formulaComposer(c);d.result?(b.alert.text("Working good.").addClass(b.opt.id+"-alert-good").removeClass(b.opt.id+"-alert-error"),"function"==typeof a&&a(!0)):(b.alert.text("Syntax error.").removeClass(b.opt.id+"-alert-good").addClass(b.opt.id+"-alert-error"),"function"==typeof a&&a(!1))}},this.destroyDrag=function(){var b=this,c=b.container.find("."+b.opt.id+"-drag");c.children("*").each(function(){var b=a(this);b.insertBefore(c)}),c.remove()},this.selectAll=function(){var b=this;b.destroyDrag(),$drag=a('<div class="'+b.opt.id+'-drag"></div>'),$drag.prependTo(b.container),b.container.children(':not(".'+b.opt.id+'-cursor")').each(function(){var b=a(this);b.appendTo($drag)})},this.click=function(b){var c=this,d=a('<div class="'+this.opt.id+'-cursor"></div>'),e=null,f=null;this.container.find("."+this.opt.id+"-cursor").remove(),d.appendTo(this.container),this.cursor=d;var g={x:c.container.offset().left,y:c.container.offset().top},h={x:parseFloat(c.container.css("padding-left").replace(/[^\d.]/gi,"")),y:parseFloat(c.container.css("padding-top").replace(/[^\d.]/gi,""))},i=[];c.container.children('*:not(".'+c.opt.id+'-cursor")').each(function(){var b=a(this);i.push({x:b.offset().left-g.x+h.x,y:b.offset().top-g.y,e:b})});var j=null,k=0,l=1e4;for(f in i)e=i[f],e.y<=b.y&&e.y>=.5*k&&e.x<=b.x&&(e.y>=k&&(k=e.y),b.x-e.x<=l&&(l=b.x-e.x,j=e.e));if(null===j){k=0,l=1e4;for(f in i)e=i[f],e.y>=.5*k&&e.x<=b.x&&(e.y>=k&&(k=e.y),b.x-e.x<l&&(l=b.x-e.x,j=e.e))}i.length>0&&null!==j&&k+i[0].e.outerHeight()>=b.y?c.cursor.insertAfter(j):i.length>0&&b.x>i[0].x?c.cursor.appendTo(c.container):c.cursor.prependTo(c.container);var m=function(){setTimeout(function(){d.hasClass("inactive")?(d.removeClass("inactive"),d.stop().animate({opacity:1},c.opt.cursorAnimTime)):(d.addClass("inactive"),d.stop().animate({opacity:0},c.opt.cursorAnimTime)),d.length>0&&m()},c.opt.cursorDelayTime)};m(),c.destroyDrag()},this.keydown=function(b,c){var d=this,e={0:")",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"x",9:"("};if(c&&b>=0&&9>=b&&(b=e[b]),b=a.trim(b),b>=0&&9>=b||-1!=a.inArray(b.toLowerCase(),d.permitedKey))if(b>=0&&9>=b||"."==b){var f=a('<div class="formula-unit">'+b+"</div>"),g=null,h="",i=!1;this.cursor.before(f),f.prev().length>0&&f.prev().hasClass("formula-unit")?(i=!0,g=f.prev()):f.next().length>0&&f.next().hasClass("formula-unit")&&(i=!0,g=f.next()),i===!0&&(g.append(f[0].innerHTML),h=g.text().toDecimal(),d.setDecimal(g,h),f.remove())}else if(""!==b){var j=a('<div class="'+d.opt.id+'-operator">'+b.toLowerCase()+"</div>");this.cursor.before(j),("("==b||")"==b)&&j.addClass(d.opt.id+"-bracket")}},this.setDecimal=function(b,c){var d=this;if(""!==c){b.empty();var e=c.split("."),f=a('<span class="'+d.opt.id+"-prefix "+d.opt.id+'-decimal-highlight">'+e[0]+"</span>");if(f.appendTo(b),"undefined"!=typeof e[1]){var g=a('<span class="'+d.opt.id+"-surfix "+d.opt.id+'-decimal-highlight">.'+e[1]+"</span>");g.appendTo(b)}}},this.getFormula=function(b){var c=this,d=null,e=null;return"function"==typeof c.opt.extract.filter?(d=[],c.container.children('*:not(".'+c.opt.id+"-cursor, ."+c.opt.id+'-drag")').each(function(){var b=a(this),e={};if(e.value=b.data("value")?b.data("value"):b.text(),b.hasClass(c.opt.id+"-unit"))e.type="unit",e.value=e.value.toDecimal();else if(b.hasClass(c.opt.id+"-operator")&&"x"==e.value)e.type="operator",e.value="*";else if(b.hasClass(c.opt.id+"-item"))if(e.type="item","undefined"!=typeof c.opt.extract&&"function"==typeof c.opt.extract.item)try{e.value=c.opt.extract.call(c,b)}catch(f){e.value="0 "}else e.value="0 ";b.hasClass(c.opt.id+"-operator")&&(e=e.value),d.push(e)}),e=new formulaComposer(d.join(",").split(",")),c.opt.extract.filter.call(c,e.result?e.data:e.msg)):(d="",c.container.children('*:not(".'+c.opt.id+'-cursor")').each(function(){var b=a(this),e=b.data("value")?b.data("value"):b.text();if(b.hasClass(c.opt.id+"-unit"))e=e.toDecimal();else if(b.hasClass(c.opt.id+"-operator")&&"x"==e)e="*";else if(b.hasClass(c.opt.id+"-item"))if("undefined"!=typeof c.opt.extract&&"function"==typeof c.opt.extract.item)try{e=c.opt.extract.call(c,b)}catch(f){e="0 "}else e="0 ";d+=e})),"function"==typeof b&&b.call(this,e?e:d),d},this.insert=function(b){var c=this;"string"==typeof b&&(b=a(b)),b.insertBefore(c.cursor),c.syntaxCheck()},d.length<1||"object"==typeof d[0]?(this.alert=null,this.text=null,this.container=null,this.cursor=null,this.opt=c,this.permitedKey=[0,1,2,3,4,5,6,7,8,9,0,"x","/",".","+","-","%","^","(",")"],a.extend(b,c),this.init.call(this)):this[b].apply(this,Array.prototype.slice.call(d,1))})}}(jQuery),formulaComposer.prototype.inArray=function(a,b){for(var c in b)if(b[c]==a)return c;return-1},formulaComposer.prototype.isOperand=function(a){return"object"==typeof a||this.isNumeric(a)},formulaComposer.prototype.isNumeric=function(a){return/\d+(\.\d*)?|\.\d+/.test(a)},formulaComposer.prototype.stringToArray=function(a){var b=[],c=a.split("");for(var d in c){var e=c[d];(-1!=this.inArray(e,this.permittedLetters)||this.isOperand(e))&&(d>0&&this.isOperand(e)&&this.isOperand(b[b.length-1])?b[b.length-1]+=e.toString():b.push(e))}return b},formulaComposer.prototype.layerParser=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if("("==e)for(var f=1,g=d+1;g<a.length;g++){var h=a[g];if("("==h)f++;else if(")"==h&&(f--,0===f)){for(var i=[],j=d+1;g>j;j++)i.push(a[j]);var k=this.search(i,b+1);if(k.result===!1)return k;a.splice(d,g-d+1,k.data),c=k.depth,d--;break}if(a.length==g+1)return{result:!1,col:g,stack:"layerParser",msg:"The bracket isn't closed"}}else if(")"==e)return{result:!1,col:d,stack:"layerParser",msg:"The bracket isn't opened"}}return{result:!0,depth:c||b}},formulaComposer.prototype.syntaxParser=function(a,b,c,d){if(a.length<3&&(d>1||1==d&&a.length>1))return{result:!1,col:0,stack:"syntaxParser",msg:"Formula must has characters than 3 times"};if(!(a.length>2))return{result:!0,data:{operator:"=",operand1:a[0]}};for(var e=1;e<a.length-1;e++){var f=a[e];if(-1==this.inArray(f,this.permittedOperators)&&!this.isOperand(f))return{result:!1,col:e,stack:"syntaxParser",msg:"'"+f+"' mark is not supported."};if(-1!=this.inArray(f,c)){if(!this.isOperand(a[e-1]))return{result:!1,col:e-1,stack:"syntaxParser"};if(!this.isOperand(a[e+1]))return{result:!1,col:e+1,stack:"syntaxParser"};var g={operator:f,operand1:a[e-1],operand2:a[e+1]};a.splice(e-1,3,g),1==a.length&&"object"==typeof a[0]&&(a=a[0]),e--}}return{result:!0,data:a}},formulaComposer.prototype.search=function(a,b){"undefined"==typeof b&&(b=1),"string"==typeof a&&(a=this.stringToArray(a));var c=null;c=this.layerParser(a,b);var d=c.depth;return c.result===!1?c:(c=this.syntaxParser(a,b,this.primaryPriority,d),c.result===!1||1==d?c:(a=c.data,c=this.syntaxParser(a,b,this.secondaryPriority,d),c.result===!1?c:(a=c.data,{result:!0,data:a,depth:d})))},formulaComposer.prototype.init=function(){return this.search(this.formula)};